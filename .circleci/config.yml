version: 2.1

# Orbs - herramientas reutilizables de CircleCI
orbs:
  docker: circleci/docker@2.2.0

# Definición de jobs
jobs:
  build-and-push:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      
      # Setup Docker buildx para builds más eficientes
      - setup_remote_docker:
          docker_layer_caching: true
      
      # Login a Docker Hub
      - run:
          name: Docker Login
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      
      # Generar tag dinámico basado en fecha y commit
      - run:
          name: Generate Tag
          command: |
            echo "export IMAGE_TAG=$(date +%Y%m%d)-${CIRCLE_SHA1:0:7}" >> $BASH_ENV
            source $BASH_ENV
            echo "Building with tag: $IMAGE_TAG"
      
      # Build de la imagen Docker
      - run:
          name: Build Docker Image
          command: |
            docker build -t markenx/markenx-django:$IMAGE_TAG \
                         -t markenx/markenx-django:latest .
      
      # Push de la imagen a Docker Hub
      - run:
          name: Push Docker Image
          command: |
            docker push markenx/markenx-django:$IMAGE_TAG
            docker push markenx/markenx-django:latest
            echo "Image pushed with tag: $IMAGE_TAG"
      
      # Mostrar información de la imagen
      - run:
          name: Image Info
          command: |
            docker images | grep markenx-django

# Workflows - orquestación de jobs
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-and-push:
          context: docker-hub
          filters:
            branches:
              only:
                - main
